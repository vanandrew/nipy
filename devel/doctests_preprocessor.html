
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Neuroimaging in Python &#8212; NIPY Documentation</title>
    <link rel="stylesheet" href="../_static/nipy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.5.0.dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Some notes on compiling on windows with Visual Studio" href="guidelines/compiling_windows.html" />
    <link rel="prev" title="Some discussion notes on coordinate maps" href="code_discussions/coordmap_notes.html" />
  <meta name="keywords" content="nipy, neuroimaging, python, neuroscience, time
				 series">

  </head>
  <body>
<div style="background-color: white; text-align: left; padding: 10px 10px 15px 15px">
 <a href="../index.html">
  <img src="../_static/reggie2.png" alt="NIPY logo"  border="0" />
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="guidelines/compiling_windows.html" title="Some notes on compiling on windows with Visual Studio"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="code_discussions/coordmap_notes.html" title="Some discussion notes on coordinate maps"
             accesskey="P">previous</a> |</li>
  <li><a href="../index.html">NIPY home</a> |&nbsp;</li>
 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

  
<h4> Site Navigation </h4>
  <ul>
    <li><a href="../documentation.html">Documentation</a></li>
    <li><a href="index.html">Development</a></li>
  </ul>

<h4> NIPY Community </h4>
  <ul class="simple">
    <li><a class="reference external"
	href="http://nipy.org/">Community Home</a></li>
    <li><a class="reference external"
	href="http://nipy.org/project-directory">NIPY Projects</a></li>
    <li><a class="reference external"
	href="https://mail.python.org/mailman/listinfo/neuroimaging">Mailing List</a></li>
    <li><a class="reference external"
	href="license.html">License</a></li>
  </ul>

<h4> Github repo </h4>
  <ul class="simple">
    <li><a class="reference external"
	href="http://github.com/nipy/nipy/">Nipy Github</a></li>
  </ul>

  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Doctest preprocessor</a><ul>
<li><a class="reference internal" href="#options">Options</a><ul>
<li><a class="reference internal" href="#standard-doctest-option-flags">Standard doctest option flags</a></li>
<li><a class="reference internal" href="#numpy-doctest-machinery">Numpy doctest machinery</a></li>
<li><a class="reference internal" href="#sympy-doctest-machinery">Sympy doctest machinery</a></li>
<li><a class="reference internal" href="#ipython-doctest-machinery">IPython doctest machinery</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="code_discussions/coordmap_notes.html"
                        title="previous chapter">Some discussion notes on coordinate maps</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="guidelines/compiling_windows.html"
                        title="next chapter">Some notes on compiling on windows with Visual Studio</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/devel/doctests_preprocessor.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>

<div id="searchbox-ml" style="display: none">
  <h3>Search mailing list archive</h3>
  <script type="text/javascript">
    function mlsearch(curobj)
    {
    curobj.q.value="site:http://mail.python.org/pipermail/neuroimaging/ "+curobj.userquery.value
    }
  </script>
  <form action="http://www.google.com/search" method="get" onSubmit="mlsearch(this)">
    <input name="userquery" size="13" type="text" /> <input type="submit" value="Go" />
    <input name="q" type="hidden" />
  </form>
</div>
  
<div id="searchbox-site" style="display: none">
  <h3>Search this site</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" size="13" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script type="text/javascript">$('#searchbox-ml').show(0);</script>
<script type="text/javascript">$('#searchbox-site').show(0);</script>


        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="doctest-preprocessor">
<h1>Doctest preprocessor<a class="headerlink" href="#doctest-preprocessor" title="Permalink to this headline">¶</a></h1>
<p>We oftentimes have output from doctests that we don’t want to test explicitly
against the output string.</p>
<p>An obvious example is decimal precision.  For example:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">1.4142135623730951</span>
</pre></div>
</div>
<p>where the last few digits depend on the CPU and math libraries on the particular
platform.  Another example are sympy tests, because the order of symbols in an
expression can be difficult to predict:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sympy</span> <span class="k">import</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">cos</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;a, b&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span>
<span class="go">a + cos(b)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s1">&#39;c, d&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cos</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span>
<span class="go">d + cos(c)</span>
</pre></div>
</div>
<p>It looks like the order is predictable for particular versions of sympy, but not
across versions.</p>
<p>A third is the classic of output dtype specific to byte ordering:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)])</span>

<span class="go">array([(0,)],</span>
<span class="go">dtype=[(&#39;f1&#39;, &#39;&lt;i4&#39;)])</span>
</pre></div>
</div>
<div class="section" id="options">
<h2>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h2>
<div class="section" id="standard-doctest-option-flags">
<h3>Standard doctest option flags<a class="headerlink" href="#standard-doctest-option-flags" title="Permalink to this headline">¶</a></h3>
<p>See: <a class="reference external" href="http://docs.python.org/library/doctest.html">http://docs.python.org/library/doctest.html</a></p>
<p>Specifically:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#doctest +ELLIPSIS</span>
<span class="go">1.414213562373...</span>
</pre></div>
</div>
<p>and:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="s1">&#39;i&#39;</span><span class="p">)])</span>

<span class="go">array([(0,)],</span>
<span class="go">dtype=[(&#39;f1&#39;, &#39;...i4&#39;)])</span>
</pre></div>
</div>
<p>So - ugly - because the reader can’t easily guess what you’ve elided, and so the
examples are hard to read.</p>
<p>And, it can’t easily deal with the sympy case above.</p>
<p>In the cases below, I found the doctest machinery by looking for
<code class="docutils literal"><span class="pre">OutputChecker</span></code> or <code class="docutils literal"><span class="pre">DoctestParser</span></code>.</p>
</div>
<div class="section" id="numpy-doctest-machinery">
<h3>Numpy doctest machinery<a class="headerlink" href="#numpy-doctest-machinery" title="Permalink to this headline">¶</a></h3>
<p>We clearly depend on Numpy.  The doctest machinery is in
<code class="docutils literal"><span class="pre">numpy/testing/noseclasses.py</span></code>.</p>
<p>Around line 232 in my version, we see:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">.</span><span class="n">globs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">:</span><span class="n">__builtins__</span><span class="p">,</span>
                <span class="s1">&#39;__file__&#39;</span><span class="p">:</span><span class="s1">&#39;__main__&#39;</span><span class="p">,</span>
                <span class="s1">&#39;__name__&#39;</span><span class="p">:</span><span class="s1">&#39;__main__&#39;</span><span class="p">,</span>
                <span class="s1">&#39;np&#39;</span><span class="p">:</span><span class="n">numpy</span><span class="p">}</span>
</pre></div>
</div>
<p>and following.  Here the normal module execution context gets overwritten by
this minimal namespace, and hence, if we used this stuff directly, we’d have to
import a load of module level stuff in every doctest - which looks messy and
makes the examples harder to read.</p>
<p>Notice around line 144, there is the <code class="docutils literal"><span class="pre">NumpyOutputChecker</span></code> - there is a hackish
check for the string <code class="docutils literal"><span class="pre">#random</span></code> that appears to result in the check being
short-cut as passed, and attempts to deal with the byte order and ‘i4’ ‘i8’
default integer for 32 and 64 bit.</p>
<p>The whole is rather difficult to work with because the class names are
hard-coded into the various method calls.</p>
<p>In summary, <code class="docutils literal"><span class="pre">numpy.testing.nosetester.NoseTester.test</span></code> initializes then calls
<code class="docutils literal"><span class="pre">NumpyTestProgram</span></code>.  <code class="docutils literal"><span class="pre">NumpyTestProgram</span></code> pulls the <code class="docutils literal"><span class="pre">doctest</span></code> nose plugin
out of the plugin list.</p>
<p>Meanwhile, in <code class="docutils literal"><span class="pre">numpy.testing.nosetester.NoseTester.prepare_test_args</span></code> (called
from the <code class="docutils literal"><span class="pre">test</span></code> method), <code class="docutils literal"><span class="pre">--with-doctest</span></code> becomes <code class="docutils literal"><span class="pre">--with-numpydoctest</span></code>,
and the method stuffs the <code class="docutils literal"><span class="pre">NumpyDoctest</span></code> and <code class="docutils literal"><span class="pre">KnownFailure</span></code> plugins into the
list of plugins.</p>
<p>So, overriding this stuff means subclassing or otherwise replacing
<code class="docutils literal"><span class="pre">NumpyDoctest</span></code> with our own doctest plugin.</p>
<p>Options are - rewrite for ourselves, or generalize numpy’s machinery, propose
pull, and meanwhile use the rewrite for our own purposes.</p>
</div>
<div class="section" id="sympy-doctest-machinery">
<h3>Sympy doctest machinery<a class="headerlink" href="#sympy-doctest-machinery" title="Permalink to this headline">¶</a></h3>
<p>We depend on sympy, but not as fundamentally as we depend on numpy.</p>
<p>Sympy’s test machinery is in <code class="docutils literal"><span class="pre">sympy/utilities/runtest.py</span></code>.</p>
<p>They don’t use <a class="reference external" href="http://nose.readthedocs.org/en/latest">nose</a>.</p>
<p>Sympy also clears the context so all names have to be imported specifically in
the doctests.  However, names imported in one doctest are available in the
others.</p>
<p>They initialize printing with:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setup_pprint</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">sympy</span> <span class="k">import</span> <span class="n">pprint_use_unicode</span><span class="p">,</span> <span class="n">init_printing</span>

    <span class="c1"># force pprint to be in ascii mode in doctests</span>
    <span class="n">pprint_use_unicode</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># hook our nice, hash-stable strprinter</span>
    <span class="n">init_printing</span><span class="p">(</span><span class="n">pretty_print</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>in that same file.  Quick tests suggested that the usual result of this is to
output strings via <code class="docutils literal"><span class="pre">sympy.printing.sstrrepr</span></code>.  This doesn’t seem to affect the
order of symbol output so doesn’t solve our problem above.</p>
</div>
<div class="section" id="ipython-doctest-machinery">
<h3>IPython doctest machinery<a class="headerlink" href="#ipython-doctest-machinery" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal"><span class="pre">IPython/testing/plugin/ipdoctest.py</span></code></p>
<p>This looks very similar to the numpy machinery.  Again, it’s a nose plugin that
inherits from the nose <code class="docutils literal"><span class="pre">Doctest</span></code> class.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="guidelines/compiling_windows.html" title="Some notes on compiling on windows with Visual Studio"
             >next</a> |</li>
        <li class="right" >
          <a href="code_discussions/coordmap_notes.html" title="Some discussion notes on coordinate maps"
             >previous</a> |</li>
  <li><a href="../index.html">NIPY home</a> |&nbsp;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2005-2017, Neuroimaging in Python team.
      Last updated on Jul 07, 2017.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>